<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map | Pharloom (JS Stitched)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English:ital@0;1&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos b치sicos integrados para que funcione al copiar y pegar */
        body { background-color: #0b0b0b; color: #eee; font-family: 'IM Fell English', serif; overflow: hidden; margin: 0; padding: 0; }
        .cinzel { font-family: 'Cinzel', serif; }
        .glow-hover:hover { text-shadow: 0 0 10px #8b1d1d; }
        .nav-link { color: #ccc; text-decoration: none; transition: color 0.3s; }
        .nav-link:hover { color: #ffb443; }
        .hamburger { width: 30px; height: 20px; position: relative; cursor: pointer; background: none; border: none; padding: 0; display: flex; flex-direction: column; justify-content: space-between; }
        .hamburger span { display: block; width: 100%; height: 2px; background-color: #ffb443; transition: all 0.3s ease; }
        .hamburger.active span:nth-child(1) { transform: translateY(9px) rotate(45deg); }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: translateY(-9px) rotate(-45deg); }
        #mobileMenu { transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        #mobileMenu.active { transform: translateX(0); }
    </style>
</head>
<body>

    <nav class="position-fixed top-0 start-0 w-100" style="z-index: 100; background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #333;">
        <div class="container-xl mx-auto d-flex justify-content-between align-items-center py-2 px-3">
            <div class="cinzel fs-5 fw-bold text-[#8b1d1d] glow-hover">WEAVER'S SANCTUM</div>
            
            <div class="d-none d-md-flex align-items-center gap-3 fs-6 text-uppercase fw-bold tracking-[0.2em]">
                <a href="../index.html#hero" class="nav-link hover:text-[#ffb443]">Sanctum</a>
                <a href="../index.html#lore" class="nav-link hover:text-[#ffb443]">Lore</a>
                <a href="../index.html#features" class="nav-link hover:text-[#ffb443]">Threads</a>
                <a href="Galery.html" class="nav-link hover:text-[#ffb443]">Explore Pharloom</a>
                <a href="Map.Html" class="nav-link hover:text-[#ffb443]">Map</a>
                <a href="Contact.html" class="nav-link hover:text-[#ffb443]">Bind Your Song</a>
                <a href="#" class="text-[#ffb443] fs-5 hover:scale-110 transition-transform">游댒</a>
            </div>
            
            <button id="hamburger" class="d-md-none hamburger"><span></span><span></span><span></span></button>
        </div>
    </nav>

    <div id="mobileMenu" class="d-md-none position-fixed top-0 start-0 w-100 h-100 d-none" style="z-index: 99; background: rgba(10, 10, 10, 0.98);">
        <div class="container-xl mx-auto d-flex flex-column align-items-center justify-content-center h-100 gap-5">
            <a href="../index.html#hero" class="nav-link fs-3">Sanctum</a>
            <a href="../index.html#lore" class="nav-link fs-3">Lore</a>
            <a href="../index.html#features" class="nav-link fs-3">Threads</a>
            <a href="Galery.html" class="nav-link fs-3">Explore Pharloom</a>
            <a href="Map.Html" class="nav-link fs-3">Map</a>
            <a href="Contact.html" class="nav-link fs-3">Bind Your Song</a>
        </div>
    </div>

    <div id="mapWrapper" style="position:fixed; top:60px; left:0; width:100vw; height:calc(100vh - 60px); z-index:1; background:#050505; overflow:hidden;">
        <svg id="pharloomMap" xmlns="http://www.w3.org/2000/svg" style="width:100%; height:100%; display:block; touch-action: none;">
            <g class="svg-pan-zoom_viewport">
                <g id="mapTilesLayer"></g>
                
                <g id="markers"></g>
            </g>
        </svg>
    </div>

    <div id="mapTip" style="position:fixed; left:20px; bottom:20px; z-index:200; color:#888; font-size:12px; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:4px; pointer-events:none;">
        Doble click para a침adir marcador / Rueda para zoom
    </div>

    <div id="tooltip" style="position:fixed; z-index:220; display:none; background:rgba(10,10,10,0.9); padding:12px; border: 1px solid #ffb443; border-radius:4px; color:#fff; min-width:200px;">
        <div id="tooltipTitle" class="fw-bold fs-5 text-warning mb-1"></div>
        <div id="tooltipDesc" class="small text-light font-monospace"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg-pan-zoom/3.6.1/svg-pan-zoom.min.js"></script>

    <script>
    (() => {
        // --- CONFIGURACI칍N DE LOS FRAGMENTOS ---
        // Se ha ajustado bas치ndose en los nombres de archivo proporcionados:
        // Columna 0, 1, 2 y Fila 0, 1.
        const mapConfig = {
            basePath: '../Images/', 
            tiles: [
                // Fila Superior (Row 0) -> Coordenadas Y=0
                { file: '6_0_0.png', col: 0, row: 0 }, // Izquierda Arriba
                { file: '6_1_0.png', col: 1, row: 0 }, // Centro Arriba (es JPG)
                { file: '6_2_0.png', col: 2, row: 0 }, // Derecha Arriba

                // Fila Inferior (Row 1) -> Coordenadas Y=1
                { file: '6_0_1.png', col: 0, row: 1 }, // Izquierda Abajo
                { file: '6_1_1.png', col: 1, row: 1 }, // Centro Abajo (es JPG)
                { file: '6_2_1.png', col: 2, row: 1 }  // Derecha Abajo
            ],
            cols: 3, // El mapa tiene 3 columnas de ancho (0, 1, 2)
            rows: 2  // El mapa tiene 2 filas de alto (0, 1)
        };

        const svg = document.getElementById('pharloomMap');
        const mapTilesLayer = document.getElementById('mapTilesLayer');
        const markersGroup = document.getElementById('markers');
        const tooltip = document.getElementById('tooltip');
        
        let panZoomInstance = null;
        let markersData = [];

        // 1. CARGA INTELIGENTE DE IMAGENES (JS STITCHING)
        function loadMapTiles() {
            // Cargamos la primera imagen para obtener las dimensiones base
            const firstTile = new Image();
            firstTile.src = mapConfig.basePath + mapConfig.tiles[0].file;
            
            firstTile.onload = () => {
                const w = firstTile.naturalWidth;
                const h = firstTile.naturalHeight;
                
                console.log(`Tile size detected: ${w}x${h}`);
                
                // Configuramos el SVG basado en cols y rows definidos
                const totalWidth = w * mapConfig.cols;
                const totalHeight = h * mapConfig.rows;
                svg.setAttribute('viewBox', `0 0 ${totalWidth} ${totalHeight}`);

                // Inyectamos las im치genes en el SVG en sus coordenadas correctas
                mapConfig.tiles.forEach(tile => {
                    const imgNS = document.createElementNS('http://www.w3.org/2000/svg', 'image');
                    const fullPath = mapConfig.basePath + tile.file;
                    imgNS.setAttributeNS('http://www.w3.org/1999/xlink', 'href', fullPath);
                    imgNS.setAttribute('x', tile.col * w);
                    imgNS.setAttribute('y', tile.row * h);
                    imgNS.setAttribute('width', w);
                    imgNS.setAttribute('height', h);
                    // Optimizaciones de renderizado
                    imgNS.style.pointerEvents = "none"; 
                    imgNS.style.userSelect = "none";
                    
                    mapTilesLayer.appendChild(imgNS);
                    console.log('Tile loaded: ' + fullPath);
                });

                // Una vez montado el mapa, iniciamos el zoom y los marcadores
                initPanZoomAndUI();
                loadMarkers();
                renderAll();
            };

            firstTile.onerror = () => {
                console.error("Error loading tile: " + firstTile.src);
                alert("Error: No se encuentra la imagen " + firstTile.src + ". Revisa la carpeta ../Images/");
            };
        }

        // 2. L칍GICA DE MARCADORES (Igual que antes)
        function saveMarkers() { localStorage.setItem('pharloom_markers', JSON.stringify(markersData)); }
        function loadMarkers() {
            try {
                const raw = localStorage.getItem('pharloom_markers');
                if (raw) markersData = JSON.parse(raw);
            } catch (e) { markersData = []; }
        }

        function createMarker(m) {
            const g = document.createElementNS('http://www.w3.org/2000/svg','g');
            g.setAttribute('cursor','pointer');
            
            // C칤rculo exterior (glow)
            const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
            circle.setAttribute('cx', m.x); circle.setAttribute('cy', m.y);
            circle.setAttribute('r', 10);
            circle.setAttribute('fill', '#ffb443');
            circle.setAttribute('stroke', '#000');
            circle.setAttribute('stroke-width', '2');
            
            // Etiqueta de texto
            const label = document.createElementNS('http://www.w3.org/2000/svg','text');
            label.setAttribute('x', m.x + 15);
            label.setAttribute('y', m.y + 5);
            label.setAttribute('fill','#fff');
            label.setAttribute('font-family', 'Cinzel, serif');
            label.setAttribute('font-weight', 'bold');
            label.setAttribute('font-size','24'); // Texto m치s grande para mapas grandes
            label.style.textShadow = "2px 2px 4px #000";
            label.textContent = m.title;

            g.appendChild(circle);
            g.appendChild(label);

            g.addEventListener('click', (ev) => {
                ev.stopPropagation();
                const ttitle = document.getElementById('tooltipTitle');
                const tdesc = document.getElementById('tooltipDesc');
                if (ttitle && tdesc) {
                    ttitle.textContent = m.title;
                    tdesc.textContent = m.desc || "Sin descripci칩n";
                    tooltip.style.display = 'block';
                    const offsetX = ev.clientX + 10;
                    const offsetY = ev.clientY + 10;
                    tooltip.style.left = Math.min(offsetX, window.innerWidth - 250) + 'px';
                    tooltip.style.top = Math.min(offsetY, window.innerHeight - 120) + 'px';
                }
            });
            
            // Click derecho para borrar
            g.addEventListener('contextmenu', (ev) => {
                ev.preventDefault();
                if(confirm('쮹orrar marcador "' + m.title + '"?')) {
                    markersData = markersData.filter(x => x.id !== m.id);
                    saveMarkers();
                    renderAll();
                }
            });

            markersGroup.appendChild(g);
        }

        function renderAll() {
            markersGroup.innerHTML = '';
            markersData.forEach(m => createMarker(m));
        }

        // 3. INICIALIZACI칍N DE PAN/ZOOM
        function initPanZoomAndUI() {
            panZoomInstance = svgPanZoom('#pharloomMap', {
                zoomEnabled: true,
                controlIconsEnabled: false,
                fit: true,
                center: true,
                minZoom: 0.1, // Permitir alejar mucho para ver todo el mapa
                maxZoom: 10
            });

            // Listener para a침adir marcador
            svg.addEventListener('dblclick', (e) => {
                if (!panZoomInstance) return;
                const rect = svg.parentElement.getBoundingClientRect();
                const pan = panZoomInstance.getPan();
                const zoom = panZoomInstance.getZoom();
                
                // C치lculo preciso de coordenadas relativas al SVG
                const x = (e.clientX - rect.left - pan.x) / zoom;
                const y = (e.clientY - rect.top - pan.y) / zoom;

                const title = prompt('Nombre del lugar:');
                if (!title) return;
                
                const desc = prompt('Descripci칩n (opcional):');
                const m = { id: Date.now(), x: Math.round(x), y: Math.round(y), title, desc };
                
                markersData.push(m);
                saveMarkers();
                renderAll();
                console.log('Marker added:', m);
            });

            // Ocultar tooltip al hacer click en el mapa vac칤o
            svg.addEventListener('click', () => { tooltip.style.display = 'none'; });
        }

        // Menu Mobile Toggle
        const hb = document.getElementById('hamburger');
        const mm = document.getElementById('mobileMenu');
        hb.addEventListener('click', () => {
            hb.classList.toggle('active');
            mm.classList.toggle('active');
        });

        // ARRANCAR
        loadMapTiles();

    })();
    </script>
</body>
</html>