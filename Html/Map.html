<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map | Pharloom (Mouse Zoom)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+English:ital@0;1&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #0b0b0b; color: #eee; font-family: 'IM Fell English', serif; overflow: hidden; margin: 0; padding: 0; }
        .cinzel { font-family: 'Cinzel', serif; }
        .glow-hover:hover { text-shadow: 0 0 10px #8b1d1d; }
        .nav-link { color: #ccc; text-decoration: none; transition: color 0.3s; }
        .nav-link:hover { color: #ffb443; }
        
        /* Mobile Menu */
        .hamburger { width: 30px; height: 20px; position: relative; cursor: pointer; background: none; border: none; padding: 0; display: flex; flex-direction: column; justify-content: space-between; }
        .hamburger span { display: block; width: 100%; height: 2px; background-color: #ffb443; transition: all 0.3s ease; }
        .hamburger.active span:nth-child(1) { transform: translateY(9px) rotate(45deg); }
        .hamburger.active span:nth-child(2) { opacity: 0; }
        .hamburger.active span:nth-child(3) { transform: translateY(-9px) rotate(-45deg); }
        .mobile-menu { display: none; }
        .mobile-menu.active { display: flex; }

        /* Cursor personalizado para indicar que se puede mover */
        #mapWrapper { cursor: grab; }
        #mapWrapper:active { cursor: grabbing; }
    </style>
</head>
<body>

    <nav class="position-fixed top-0 start-0 w-100" style="z-index: 100; background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #333;">
        <div class="container-xl mx-auto d-flex justify-content-between align-items-center py-2 px-3">
            <div class="cinzel fs-5 fw-bold text-[#8b1d1d] glow-hover">WEAVER'S SANCTUM</div>
            
            <div class="d-none d-md-flex align-items-center gap-3 fs-6 text-uppercase fw-bold tracking-[0.2em]">
                <a href="../index.html" class="nav-link hover:text-[#ffb443]"><i class="fas fa-home me-1"></i>Sanctum</a>
                <a href="../Html/Lore.html" class="nav-link hover:text-[#ffb443]"><i class="fas fa-book me-1"></i>Lore</a>
                <a href="../Html/Galery.html" class="nav-link hover:text-[#ffb443]"><i class="fas fa-images me-1"></i>Explore Pharloom</a>
                <a href="../Html/Map.html" class="nav-link hover:text-[#ffb443]"><i class="fas fa-map me-1"></i>Map</a>
                <a href="../Html/Video.html" class="nav-link hover:text-[#ffb443]"><i class="fas fa-video me-1"></i>Videos</a>
                <a href="../Html/Contact.html" class="nav-link hover:text-[#ffb443]"><i class="fas fa-envelope me-1"></i>Bind Your Song</a>
                <a href="#" class="text-[#ffb443] fs-5 hover:scale-110 transition-transform">üîî</a>
            </div>
            
            <button id="hamburger" class="d-md-none hamburger"><span></span><span></span><span></span></button>
        </div>
    </nav>

    <div id="mobileMenu" class="d-md-none position-fixed top-0 start-0 w-100 h-100 d-none" style="z-index: 99; background: rgba(10, 10, 10, 0.98);">
        <div class="container-xl mx-auto d-flex flex-column align-items-center justify-content-center h-100 gap-5">
            <a href="../index.html" class="nav-link fs-3">Sanctum</a>
            <a href="../Html/Lore.html" class="nav-link fs-3">Lore</a>
            <a href="../Html/Galery.html" class="nav-link fs-3">Explore Pharloom</a>
            <a href="../Html/Map.html" class="nav-link fs-3">Map</a>
            <a href="../Html/Video.html" class="nav-link fs-3">Videos</a>
            <a href="../Html/Contact.html" class="nav-link fs-3">Bind Your Song</a>
        </div>
    </div>

    <!-- Backdrop -->
    <div id="backdrop" class="d-md-none position-fixed top-0 start-0 w-100 h-100 d-none" style="z-index: 98; background: rgba(0, 0, 0, 0.5);"></div>

    <div id="mapWrapper" style="position:fixed; top:60px; left:0; width:100vw; height:calc(100vh - 60px); z-index:1; background:#050505; overflow:hidden;">
        <svg id="pharloomMap" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000" style="width:100%; height:100%; display:block; touch-action: none;">
            <g class="svg-pan-zoom_viewport">
                <g id="mapTilesLayer"></g>
                <g id="markers"></g>
            </g>
        </svg>
    </div>

    <div id="mapTip" style="position:fixed; left:20px; bottom:20px; z-index:200; color:#888; font-size:12px; background:rgba(0,0,0,0.5); padding:5px 10px; border-radius:4px; pointer-events:none;">
        Usa la rueda del rat√≥n para Zoom | Doble Click para Marcador
    </div>

    <div id="tooltip" style="position:fixed; z-index:220; display:none; background:rgba(10,10,10,0.9); padding:12px; border: 1px solid #ffb443; border-radius:4px; color:#fff; min-width:200px;">
        <div id="tooltipTitle" class="fw-bold fs-5 text-warning mb-1"></div>
        <div id="tooltipDesc" class="small text-light font-monospace"></div>
    </div>

    <style>
        #zoomControls { position: fixed; right: 16px; top: 80px; z-index:250; display:flex; flex-direction:column; gap:8px; }
        .zoom-btn { background:#111; color:#ffb443; border:1px solid #333; padding:8px 10px; border-radius:6px; font-weight:bold; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.6); }
        .zoom-btn:hover { background:#0d0d0d; transform:translateY(-1px); }

        #mapTilesLayer {
            transition: transform 0.1s ease-out;
        }
    </style>

    <script>
    (() => {
        // --- CONFIGURACI√ìN ---
        const mapConfig = {
            basePath: '../Images/', 
            tiles: [
                // Fila 0 (Arriba)
                { file: '6_0_0.png', col: 0, row: 0 },
                { file: '6_1_0.png', col: 1, row: 0 },
                { file: '6_2_0.png', col: 2, row: 0 },
                // Fila 1 (Abajo)
                { file: '6_0_1.png', col: 0, row: 1 },
                { file: '6_1_1.png', col: 1, row: 1 },
                { file: '6_2_1.png', col: 2, row: 1 }
            ],
            cols: 3, 
            rows: 2 
        };

        const svg = document.getElementById('pharloomMap');
        const mapTilesLayer = document.getElementById('mapTilesLayer');
        const markersGroup = document.getElementById('markers');
        const tooltip = document.getElementById('tooltip');
        
        let panZoomInstance = null;
        let markersData = [];

        // 1. CARGA DE IM√ÅGENES
        function loadMapTiles() {
            const firstTile = new Image();
            firstTile.src = mapConfig.basePath + mapConfig.tiles[0].file;
            
            firstTile.onload = () => {
                const w = firstTile.naturalWidth;
                const h = firstTile.naturalHeight;

                // Configurar tama√±o del SVG
                const totalWidth = w * mapConfig.cols;
                const totalHeight = h * mapConfig.rows;
                svg.setAttribute('viewBox', `0 0 ${totalWidth} ${totalHeight}`);

                // Inyectar im√°genes
                mapConfig.tiles.forEach(tile => {
                    const imgNS = document.createElementNS('http://www.w3.org/2000/svg', 'image');
                    const fullPath = mapConfig.basePath + tile.file;
                    imgNS.setAttributeNS('http://www.w3.org/1999/xlink', 'href', fullPath);
                    imgNS.setAttribute('x', tile.col * w);
                    imgNS.setAttribute('y', tile.row * h);
                    imgNS.setAttribute('width', w);
                    imgNS.setAttribute('height', h);

                    // IMPORTANTE: pointer-events none para que el rat√≥n "atraviese" la imagen
                    // y el evento de zoom funcione en el SVG contenedor.
                    imgNS.style.pointerEvents = "none";

                    mapTilesLayer.appendChild(imgNS);
                });

                initPanZoomAndUI();

                loadMarkers();
                renderAll();
            };
            
            firstTile.onerror = () => {
                console.error("No se pudo cargar: " + firstTile.src);
            };
        }

        // 2. MARCADORES
        function saveMarkers() { localStorage.setItem('pharloom_markers', JSON.stringify(markersData)); }
        function loadMarkers() {
            try {
                const raw = localStorage.getItem('pharloom_markers');
                if (raw) markersData = JSON.parse(raw);
            } catch (e) { markersData = []; }
        }

        function createMarker(m) {
            const g = document.createElementNS('http://www.w3.org/2000/svg','g');
            g.setAttribute('cursor','pointer');
            
            const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
            circle.setAttribute('cx', m.x); circle.setAttribute('cy', m.y);
            circle.setAttribute('r', 10);
            circle.setAttribute('fill', '#ffb443');
            circle.setAttribute('stroke', '#000');
            circle.setAttribute('stroke-width', '2');
            
            const label = document.createElementNS('http://www.w3.org/2000/svg','text');
            label.setAttribute('x', m.x + 15);
            label.setAttribute('y', m.y + 5);
            label.setAttribute('fill','#fff');
            label.setAttribute('font-family', 'Cinzel, serif');
            label.setAttribute('font-weight', 'bold');
            label.setAttribute('font-size','24');
            label.style.textShadow = "2px 2px 4px #000";
            label.textContent = m.title;

            g.appendChild(circle);
            g.appendChild(label);

            g.addEventListener('click', (ev) => {
                ev.stopPropagation();
                document.getElementById('tooltipTitle').textContent = m.title;
                document.getElementById('tooltipDesc').textContent = m.desc || "";
                tooltip.style.display = 'block';
                tooltip.style.left = (ev.clientX + 10) + 'px';
                tooltip.style.top = (ev.clientY + 10) + 'px';
            });
            
            g.addEventListener('contextmenu', (ev) => {
                ev.preventDefault();
                if(confirm('¬øBorrar marcador?')) {
                    markersData = markersData.filter(x => x.id !== m.id);
                    saveMarkers(); renderAll();
                }
            });

            markersGroup.appendChild(g);
        }

        function renderAll() {
            markersGroup.innerHTML = '';
            markersData.forEach(m => createMarker(m));
        }

        // 3. INICIALIZAR ZOOM Y PANNING PERSONALIZADO
        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        let isDragging = false;
        let lastX = 0;
        let lastY = 0;

        const minScale = 0.1;
        const maxScale = 20;

        function updateTransform() {
            mapTilesLayer.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            markersGroup.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        }

        function zoom(factor, centerX, centerY) {
            const newScale = Math.max(minScale, Math.min(maxScale, scale * factor));

            if (newScale !== scale) {
                // Adjust translation to zoom towards the mouse position
                const scaleChange = newScale / scale;
                translateX = centerX - (centerX - translateX) * scaleChange;
                translateY = centerY - (centerY - translateY) * scaleChange;
                scale = newScale;
                updateTransform();
            }
        }

        function pan(deltaX, deltaY) {
            translateX += deltaX;
            translateY += deltaY;
            updateTransform();
        }

        function initPanZoomAndUI() {

            // Mouse wheel zoom
            svg.addEventListener('wheel', (e) => {
                e.preventDefault();
                const rect = svg.getBoundingClientRect();
                const centerX = e.clientX - rect.left;
                const centerY = e.clientY - rect.top;
                const factor = e.deltaY > 0 ? 0.9 : 1.1;
                zoom(factor, centerX, centerY);
            });

            // Mouse pan
            svg.addEventListener('mousedown', (e) => {
                if (e.button === 0) { // Left mouse button
                    isDragging = true;
                    lastX = e.clientX;
                    lastY = e.clientY;
                    svg.style.cursor = 'grabbing';
                }
            });

            svg.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaX = e.clientX - lastX;
                    const deltaY = e.clientY - lastY;
                    pan(deltaX, deltaY);
                    lastX = e.clientX;
                    lastY = e.clientY;
                }
            });

            svg.addEventListener('mouseup', () => {
                isDragging = false;
                svg.style.cursor = 'grab';
            });

            svg.addEventListener('mouseleave', () => {
                isDragging = false;
                svg.style.cursor = 'grab';
            });

            // Utility: convert client coordinates to SVG coordinates
            function clientToSVGCoords(clientX, clientY) {
                const rect = svg.getBoundingClientRect();
                const svgX = (clientX - rect.left - translateX) / scale;
                const svgY = (clientY - rect.top - translateY) / scale;
                return { x: svgX, y: svgY };
            }

            // A√±adir marcador con Doble Click
            svg.addEventListener('dblclick', (e) => {
                const pt = clientToSVGCoords(e.clientX, e.clientY);
                const x = Math.round(pt.x);
                const y = Math.round(pt.y);

                const title = prompt('Nombre del lugar:');
                if (!title) return;
                const desc = prompt('Descripci√≥n (opcional):');
                markersData.push({ id: Date.now(), x: Math.round(x), y: Math.round(y), title, desc });
                saveMarkers(); renderAll();
            });

            // Ocultar tooltip al hacer click fuera
            svg.addEventListener('click', () => { tooltip.style.display = 'none'; });
        }

        // Toggle Men√∫ M√≥vil
        const hb = document.getElementById('hamburger');
        const mm = document.getElementById('mobileMenu');
        const backdrop = document.getElementById('backdrop');
        const mobileLinks = mm.querySelectorAll('a');

        function toggleMenu() {
            hb.classList.toggle('active');
            mm.classList.toggle('active');
            mm.classList.toggle('d-none');
            backdrop.classList.toggle('d-none');

            // Prevent body scroll when menu is open
            document.body.style.overflow = mm.classList.contains('active') ? 'hidden' : '';
        }

        // Open/close menu on hamburger click
        hb.addEventListener('click', toggleMenu);

        // Close menu when backdrop is clicked
        backdrop.addEventListener('click', toggleMenu);

        // Close menu when a link is clicked
        mobileLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (mm.classList.contains('active')) {
                    toggleMenu();
                }
            });
        });

        // Close menu on window resize to desktop size
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768 && mm.classList.contains('active')) {
                toggleMenu();
            }
        });

        // Add simple zoom controls for testing/backup
        const controls = document.createElement('div');
        controls.id = 'zoomControls';
        controls.innerHTML = '<button id="zoomIn" class="zoom-btn">Ôºã</button><button id="zoomOut" class="zoom-btn">Ôºç</button><button id="resetZoom" class="zoom-btn">Reset</button>';
        document.body.appendChild(controls);

        // Make zoom controls work with custom zoom system
        let zoomControls = {
            zoomIn: () => zoom(1.2, svg.clientWidth / 2, svg.clientHeight / 2),
            zoomOut: () => zoom(0.8, svg.clientWidth / 2, svg.clientHeight / 2),
            resetZoom: () => {
                scale = 1;
                translateX = 0;
                translateY = 0;
                updateTransform();
            }
        };

        document.getElementById('zoomIn').addEventListener('click', zoomControls.zoomIn);
        document.getElementById('zoomOut').addEventListener('click', zoomControls.zoomOut);
        document.getElementById('resetZoom').addEventListener('click', zoomControls.resetZoom);

        loadMapTiles();

    })();
    </script>

    <!-- FOOTER SECTION - Site information, navigation, and copyright -->
    <footer class="bg-dark text-light py-5">
        <div class="container-xl mx-auto px-3">
            <div class="row g-4">
                <!-- Footer Column 1: Branding & Social -->
                <div class="col-12 col-md-4">
                    <div class="cinzel fs-4 fw-bold text-uppercase mb-3" style="color: var(--silk-red);">Weaver's Sanctum</div>
                    <p class="opacity-75 mb-3">A sanctuary for those who seek the threads of destiny and the songs of forgotten ages.</p>
                    <!-- Social Media Links -->
                    <div class="d-flex gap-3">
                        <a href="#" class="text-light fs-4"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="text-light fs-4"><i class="fab fa-discord"></i></a>
                        <a href="#" class="text-light fs-4"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
                <!-- Footer Column 2: Navigation Links -->
                <div class="col-12 col-md-4">
                    <h5 class="cinzel text-uppercase mb-3" style="color: var(--amber-glow);">Navigation</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><a href="../index.html" class="text-light text-decoration-none">Sanctum</a></li>
                        <li class="mb-2"><a href="../Html/Lore.html" class="text-light text-decoration-none">Lore</a></li>
                        <li class="mb-2"><a href="../Html/Galery.html" class="text-light text-decoration-none">Explore Pharloom</a></li>
                        <li class="mb-2"><a href="../Html/Map.html" class="text-light text-decoration-none">Map</a></li>
                        <li class="mb-2"><a href="../Html/Video.html" class="text-light text-decoration-none">Videos</a></li>
                        <li class="mb-2"><a href="../Html/Contact.html" class="text-light text-decoration-none">Bind Your Song</a></li>
                    </ul>
                </div>
                <!-- Footer Column 3: Core Themes -->
                <div class="col-12 col-md-4">
                    <h5 class="cinzel text-uppercase mb-3" style="color: var(--amber-glow);">The Three Pillars</h5>
                    <ul class="list-unstyled">
                        <li class="mb-2"><span style="color: var(--amber-glow);">ü™°</span> The Needle</li>
                        <li class="mb-2"><span style="color: var(--amber-glow);">üîî</span> The Song</li>
                        <li class="mb-2"><span style="color: var(--amber-glow);">üï∏Ô∏è</span> The Silk</li>
                    </ul>
                </div>
            </div>
            <hr class="my-4" style="border-color: rgba(139, 29, 29, 0.3);">
            <!-- Copyright Notice -->
            <div class="text-center opacity-75">
                <p class="mb-0">&copy; 2025 Weaver's Sanctum. All threads are woven with care.</p>
            </div>
        </div>
    </footer>
</body>
</html>
